<div class="container">
  <div>
    <h2><i class="fas fa-database"></i> {{ datasetName || UI_TEXT.headers.dataset }} </h2>

    <!-- Tabs -->
    <div class="tabs">
      <button type="button" class="tab" [class.active]="activeTab() === 'data'" (click)="activeTab.set('data')">
        <i class="fas fa-table"></i> {{ UI_TEXT.tabs.data }}
      </button>
      <button type="button" class="tab" [class.active]="activeTab() === 'graph' && graphType() === 'actual'"
              (click)="setGraphType('actual')">
        <i class="fas fa-chart-line"></i> {{ UI_TEXT.headers.graph.actual }}
      </button>
      <button type="button" class="tab" [class.active]="activeTab() === 'graph' && graphType() === 'target'"
              (click)="setGraphType('target')">
        <i class="fas fa-bullseye"></i> {{ UI_TEXT.headers.graph.target }}
      </button>
      <button type="button" class="tab" [class.active]="activeTab() === 'graph' && graphType() === 'endDate'"
              (click)="setGraphType('endDate')">
        <i class="fas fa-calendar-alt"></i> {{ UI_TEXT.headers.graph.endDate }}
      </button>
      <button type="button" class="tab" [class.active]="activeTab() === 'edit'" (click)="activeTab.set('edit')">
        <i class="fas fa-pen"></i> {{ UI_TEXT.headers.edit }}
      </button>
    </div>

    <!-- Data tab -->
    <div *ngIf="activeTab() === 'data'">
      <h3>{{ UI_TEXT.headers.entries }}</h3>

      <!-- Filters & actions -->
      <div class="toolbar" style="display:flex; gap:12px; align-items:end; flex-wrap:wrap; margin: 8px 0 12px 0;">
        <div style="display:flex; flex-direction:column;">
          <label>{{ UI_TEXT.labels.search }}</label>
          <input type="text" [(ngModel)]="filterQuery" [placeholder]="UI_TEXT.placeholders.searchLabel"/>
        </div>
        <div style="display:flex; flex-direction:column;">
          <label>{{ UI_TEXT.labels.from }}</label>
          <input type="date" [(ngModel)]="filterFrom" (click)="openPicker($event)"/>
        </div>
        <div style="display:flex; flex-direction:column;">
          <label>{{ UI_TEXT.labels.to }}</label>
          <input type="date" [(ngModel)]="filterTo" (click)="openPicker($event)"/>
        </div>
        <div style="display:flex; flex-direction:column;">
          <label>{{ UI_TEXT.labels.sortBy }}</label>
          <div style="display:flex; gap:6px;">
            <select [(ngModel)]="sortBy">
              <option value="date">{{ UI_TEXT.sorting.date }}</option>
              <option value="value">{{ UI_TEXT.sorting.value }}</option>
            </select>
            <select [(ngModel)]="sortDir">
              <option value="desc">{{ UI_TEXT.sorting.desc }}</option>
              <option value="asc">{{ UI_TEXT.sorting.asc }}</option>
            </select>
          </div>
        </div>
        <div style="margin-left:auto; display:flex; gap:8px;">
          <button class="btn btn-secondary" type="button" (click)="filterQuery=''; filterFrom=''; filterTo=''">{{ UI_TEXT.buttons.clearFilters }}</button>
          <button class="btn btn-secondary" type="button" (click)="exportFilteredCsv()"><i class="fas fa-file-csv"></i> {{ UI_TEXT.buttons.exportCsv }}</button>
        </div>
      </div>

      <!-- Quick stats -->
      <div class="stats">
        <div class="stat-card">
          <div class="label">{{ UI_TEXT.stats.count }}</div>
          <div class="value">{{ stats.count }}</div>
        </div>
        <div class="stat-card">
          <div class="label">{{ UI_TEXT.stats.avg }}</div>
          <div class="value">{{ stats.avg | number:'1.0-2' }}</div>
        </div>
        <div class="stat-card">
          <div class="label">{{ UI_TEXT.stats.sum }}</div>
          <div class="value">{{ stats.sum | number:'1.0-2' }}</div>
        </div>
        <div class="stat-card">
          <div class="label">{{ UI_TEXT.stats.timeSpan }}</div>
          <div class="value">{{ stats.timeSpan || 'â€”' }}</div>
        </div>
      </div>

      <table class="table">
        <thead>
        <tr>
          <th>{{ UI_TEXT.table.label }}</th>
          <th style="width: 220px;">{{ UI_TEXT.table.value }}</th>
          <th style="width: 220px;">{{ UI_TEXT.table.date }}</th>
          <th style="width: 300px;">{{ UI_TEXT.table.actions }}</th>
        </tr>
        </thead>
        <tbody>
        <tr>
          <td><input type="text" [(ngModel)]="newEntry.label" [placeholder]="UI_TEXT.placeholders.label" (keyup.enter)="addEntry()"/></td>
          <td><input type="number" [(ngModel)]="newEntry.value" [placeholder]="UI_TEXT.placeholders.value" (keyup.enter)="addEntry()"/></td>
          <td><input type="date" [(ngModel)]="newEntry.date" (click)="openPicker($event)" (keyup.enter)="addEntry()"/></td>
          <td>
            <button class="btn btn-primary" type="button" (click)="addEntry()">
              <i class="fas fa-plus"></i> {{ UI_TEXT.buttons.add }}
            </button>
            <button class="btn btn-secondary" type="button" (click)="resetNewEntry()">
              <i class="fas fa-broom"></i> {{ UI_TEXT.buttons.clear }}
            </button>
          </td>
        </tr>

        <tr *ngFor="let e of viewEntries()">
          <td><input type="text" [(ngModel)]="e.label"/></td>
          <td><input type="number" [(ngModel)]="e.value"/></td>
          <td><input type="date" [(ngModel)]="e.date" (click)="openPicker($event)"/></td>
          <td>
            <button class="btn btn-primary" type="button" (click)="saveEntry(e)">
              <i class="fas fa-save"></i> {{ UI_TEXT.buttons.save }}
            </button>
            <button class="btn btn-danger" type="button" (click)="deleteEntry(e)">
              <i class="fas fa-trash-alt"></i> {{ UI_TEXT.buttons.delete }}
            </button>
          </td>
        </tr>

        <tr *ngIf="entriesLoading()">
          <td colspan="4">{{ UI_TEXT.table.loading }}</td>
        </tr>
        </tbody>
      </table>
    </div>

    <!-- Graph tab -->
    <div class="chart-container" *ngIf="activeTab() === 'graph'">
      <ng-container *ngIf="graphLoading(); else graphContent">
        {{ UI_TEXT.graph.loading }}
      </ng-container>

      <ng-template #graphContent>
        <div *ngIf="chartData.length; else noData">
          <div class="chart-content">
            <div class="chart-main">
              <div class="chart-controls">
                <div class="control-group" style="justify-content: space-between;">
                  <span class="group-label">{{ UI_TEXT.graph.range.label }}</span>
                  <div class="btn-group">
                    <button type="button" class="btn btn-chip" [class.active]="rangePreset==='all'" (click)="setRange('all')">{{ UI_TEXT.graph.range.all }}</button>
                    <button type="button" class="btn btn-chip" [class.active]="rangePreset==='30d'" (click)="setRange('30d')">{{ UI_TEXT.graph.range.d30 }}</button>
                    <button type="button" class="btn btn-chip" [class.active]="rangePreset==='7d'" (click)="setRange('7d')">{{ UI_TEXT.graph.range.d7 }}</button>
                  </div>
                </div>
                <div class="control-group" style="align-items: center; gap: 12px;">
                  <span class="group-label">{{ UI_TEXT.graph.optionsLabel }}</span>
                  <label class="switch"><input type="checkbox" [checked]="robustScale()" (change)="robustScale.set($any($event.target).checked)"/><span> {{ UI_TEXT.graph.controls.robustScale }}</span></label>
                  <label class="switch"><input type="checkbox" [checked]="smoothLine()" (change)="smoothLine.set($any($event.target).checked)"/><span> {{ UI_TEXT.graph.controls.smoothLine }}</span></label>
                  <label class="switch"><input type="checkbox" [checked]="roundDomains()" (change)="roundDomains.set($any($event.target).checked)"/><span> {{ UI_TEXT.graph.controls.roundDomains }}</span></label>
                  <label class="switch"><input type="checkbox" [checked]="showTimeline()" (change)="showTimeline.set($any($event.target).checked)"/><span> {{ UI_TEXT.graph.controls.timeline }}</span></label>
                </div>
              </div>
              <div class="chart-wrapper">
                <ngx-charts-line-chart
                  [scheme]="colorScheme"
                  [results]="chartData"
                  [xAxis]="true"
                  [yAxis]="true"
                  [legend]="true"
                  [legendPosition]="LegendPosition.Below"
                  [showXAxisLabel]="true"
                  [showYAxisLabel]="true"
                  [xAxisLabel]="UI_TEXT.graph.xAxis"
                  [yAxisLabel]="UI_TEXT.graph.yAxis + (datasetSymbol ? ' (' + datasetSymbol + ')' : '')"
                  [autoScale]="!robustScale()"
                  [roundDomains]="roundDomains()"
                  [yScaleMin]="$any(robustScale() ? yScaleMin : undefined)"
                  [yScaleMax]="$any(robustScale() ? yScaleMax : undefined)"
                  [xScaleMin]="$any(xScaleMin)"
                  [xScaleMax]="$any(xScaleMax)"
                  [curve]="curve"
                  [timeline]="showTimeline()"
                  [animations]="false"
                  [showGridLines]="true"
                  [xAxisTickFormatting]="formatDateTick"
                  [yAxisTickFormatting]="formatValueTick"
                  [showRefLines]="referenceLines.length>0"
                  [referenceLines]="referenceLines"
                  [showRefLabels]="true"
                >
                </ngx-charts-line-chart>
              </div>
            </div>
          </div>
        </div>
        <ng-template #noData>{{ UI_TEXT.headers.chartNoData }}</ng-template>
      </ng-template>
    </div>

    <!-- Edit tab -->
    <div *ngIf="activeTab() === 'edit'">
      <app-dataset-form></app-dataset-form>
    </div>
  </div>
</div>
